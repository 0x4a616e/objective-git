#!/bin/sh

set -e

# augment path to help it find cmake installed in /usr/local/bin,
# e.g. via brew. Xcode's Run Script phase doesn't seem to honor
# ~/.MacOSX/environment.plist
PATH="/usr/local/bin:/opt/boxen/homebrew/bin:$PATH"

# source the common build functions
SCRIPT_PATH=`dirname $0`
source "${SCRIPT_PATH}/ios_build_functions.sh"


function setup ()
{
    if [ -f "${ROOT_PATH}/External/libssh2-ios/lib/libssh2-ios.a" ]; then
        echo "No update needed."
        exit 0
    fi
    LIBRARY_NAME="libssh2"
    BUILT_LIBS=()
}

function build_ssh2 () 
{
  mkdir -p ${ROOT_PATH}/External/libssh2-ios/lib ${ROOT_PATH}/External/libssh2-ios/lib ${ROOT_PATH}/External/libssh2-ios/src
  
  rm -rf ${ROOT_PATH}/External/libssh2-ios/src/libssh2
  cp -R ${ROOT_PATH}/External/libssh2 ${ROOT_PATH}/External/libssh2-ios/src/
  cd ${ROOT_PATH}/External/libssh2-ios/src/libssh2
  
  export CFLAGS="-arch ${ARCH} -pipe -no-cpp-precomp -isysroot ${SDKROOT} -miphoneos-version-min=${IPHONEOS_DEPLOYMENT_TARGET}"
  export CPPFLAGS="-arch ${ARCH} -pipe -no-cpp-precomp -isysroot ${SDKROOT} -miphoneos-version-min=${IPHONEOS_DEPLOYMENT_TARGET}"

  mkdir -p "${ROOT_PATH}/External/libssh2-ios/bin/${PLATFORM}${SDKVERSION}-${ARCH}.sdk"
  LOG="${ROOT_PATH}/External/libssh2-ios/bin/${PLATFORM}${SDKVERSION}-${ARCH}.sdk/build-libssh2.log"

  echo ${LOG}

  ./buildconf >> "${LOG}" 2>&1
  ./configure --host=${HOST} --prefix="${ROOT_PATH}/External/libssh2-ios/bin/${PLATFORM}${SDKVERSION}-${ARCH}.sdk" --with-openssl --with-libssl-prefix=${ROOT_PATH}/External/ios-openssl --disable-shared --enable-static >> "${LOG}" 2>&1
  make >> "${LOG}" 2>&1
  make install >> "${LOG}" 2>&1
  
  BUILT_LIBS+=("${ROOT_PATH}/External/libssh2-ios/bin/${PLATFORM}${SDKVERSION}-${ARCH}.sdk/lib/libssh2.a")
}

function fat_binary ()
{
    echo "Building fat binary..."

    lipo -create ${BUILT_LIBS[@]} -output ${ROOT_PATH}/External/libssh2-ios/lib/libssh2-ios.a
    mkdir -p ${ROOT_PATH}/External/libssh2-ios/include/libssh2
    cp -R ${ROOT_PATH}/External/libssh2-ios/bin/iPhoneSimulator${SDKVERSION}-i386.sdk/include/libssh2* ${ROOT_PATH}/External/libssh2-ios/include/libssh2/

    echo "Building done."
}

build_all_archs setup build_ssh2 fat_binary
