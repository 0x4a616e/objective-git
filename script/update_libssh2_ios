#!/bin/sh

set -e

# augment path to help it find cmake installed in /usr/local/bin,
# e.g. via brew. Xcode's Run Script phase doesn't seem to honor
# ~/.MacOSX/environment.plist
PATH="/usr/local/bin:/opt/boxen/homebrew/bin:$PATH"

# source the common build functions
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
source "${DIR}/update_ios_lib"

prepare_build_variables

if [ -f "${CURRENT_PATH}/External/libssh2-ios/lib/libssh2-ios.a" ]; then
    echo "No update needed."
    exit 0
fi

LIBRARY_NAME="libssh2"

function build_ssh2 {
  mkdir -p ${CURRENT_PATH}/External/libssh2-ios/lib ${CURRENT_PATH}/External/libssh2-ios/lib ${CURRENT_PATH}/External/libssh2-ios/src
  
  rm -rf ${CURRENT_PATH}/External/libssh2-ios/src/libssh2
  cp -R ${CURRENT_PATH}/External/libssh2 ${CURRENT_PATH}/External/libssh2-ios/src/
  cd ${CURRENT_PATH}/External/libssh2-ios/src/libssh2
  
  export CFLAGS="-arch ${ARCH} -pipe -no-cpp-precomp -isysroot ${SDKROOT} -miphoneos-version-min=${IPHONEOS_DEPLOYMENT_TARGET}"
  export CPPFLAGS="-arch ${ARCH} -pipe -no-cpp-precomp -isysroot ${SDKROOT} -miphoneos-version-min=${IPHONEOS_DEPLOYMENT_TARGET}"

  mkdir -p "${CURRENT_PATH}/External/libssh2-ios/bin/${PLATFORM}${SDKVERSION}-${ARCH}.sdk"
  LOG="${CURRENT_PATH}/External/libssh2-ios/bin/${PLATFORM}${SDKVERSION}-${ARCH}.sdk/build-libssh2.log"

  echo ${LOG}

  ./buildconf >> "${LOG}" 2>&1
  ./configure --host=${HOST} --prefix="${CURRENTPATH}/External/libssh2-ios/bin/${PLATFORM}${SDKVERSION}-${ARCH}.sdk" --with-openssl --with-libssl-prefix=${CURRENT_PATH}/External/ios-openssl --disable-shared --enable-static >> "${LOG}" 2>&1
  make >> "${LOG}" 2>&1
  make install >> "${LOG}" 2>&1
}

build_all_archs build_ssh2

echo "Building fat library..."

lipo -create ${CURRENT_PATH}/External/libssh2-ios/bin/iPhoneSimulator${SDKVERSION}-i386.sdk/lib/libssh2.a ${CURRENT_PATH}/External/libssh2-ios/bin/iPhoneOS${SDKVERSION}-armv7.sdk/lib/libssh2.a ${CURRENT_PATH}/External/libssh2-ios/bin/iPhoneOS${SDKVERSION}-armv7s.sdk/lib/libssh2.a -output ${CURRENT_PATH}/External/libssh2-ios/lib/libssh2-ios.a
mkdir -p ${CURRENT_PATH}/External/libssh2-ios/include/libssh2
cp -R ${CURRENT_PATH}/External/libssh2-ios/bin/iPhoneSimulator${SDKVERSION}-i386.sdk/include/libssh2* ${CURRENT_PATH}/External/libssh2-ios/include/libssh2/

echo "Building done."
